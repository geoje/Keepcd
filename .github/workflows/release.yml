name: Build and Release

on:
  workflow_dispatch: # Manual execution by pressing the button

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      CHROMEDRIVER_URL: https://storage.googleapis.com/chrome-for-testing-public/145.0.7632.67/mac-arm64/chromedriver-mac-arm64.zip
      CHROME_URL: https://storage.googleapis.com/chrome-for-testing-public/145.0.7632.67/mac-arm64/chrome-mac-arm64.zip

    steps:
      - name: Cache Chrome binaries
        id: cache-chrome
        uses: actions/cache@v5
        with:
          path: Binaries
          key: chrome-binaries-${{ env.CHROMEDRIVER_URL }}-${{ env.CHROME_URL }}

      - name: Download chromedriver
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          mkdir -p Binaries
          curl -L -o chromedriver.zip "$CHROMEDRIVER_URL"
          unzip -o chromedriver.zip
          mv chromedriver-mac-arm64/chromedriver Binaries/chromedriver
          rm -rf chromedriver.zip chromedriver-mac-arm64

      - name: Download Chrome
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          mkdir -p Binaries
          curl -L -o chrome.zip "$CHROME_URL"
          unzip -o chrome.zip
          mv chrome-mac-arm64/Google\ Chrome\ for\ Testing.app Binaries/Google\ Chrome\ for\ Testing.app
          rm -rf chrome.zip chrome-mac-arm64

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version variables
        id: vars
        run: |
          echo "MARKETING_VERSION=$(date +'%y.%-m').${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "CURRENT_PROJECT_VERSION=$(date +'%Y%m%d').${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "Marketing Version: ${{ steps.vars.outputs.MARKETING_VERSION }}"
          echo "Current Project Version: ${{ steps.vars.outputs.CURRENT_PROJECT_VERSION }}"

      - name: Update project versions
        run: |
          sed -i '' "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${{ steps.vars.outputs.MARKETING_VERSION }}/" Keep.xcodeproj/project.pbxproj
          sed -i '' "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = ${{ steps.vars.outputs.CURRENT_PROJECT_VERSION }}/" Keep.xcodeproj/project.pbxproj
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Keep.xcodeproj/project.pbxproj
          git commit -m "update version to ${{ steps.vars.outputs.MARKETING_VERSION }} (${{ steps.vars.outputs.CURRENT_PROJECT_VERSION }})" || echo "no changes to commit"
          git push origin main

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      # The following steps are temporarily disabled for cache testing
      # - name: Build Archive
      #   run: |
      #     xcodebuild archive \
      #       -project Keep.xcodeproj \
      #       -scheme Keep \
      #       -configuration Release \
      #       -archivePath .build/Keep.xcarchive \
      #       -destination "generic/platform=macOS"

      # - name: Export App and Re-sign
      #   run: |
      #     mkdir -p ./dist
      #     cp -R ./.build/Keep.xcarchive/Products/Applications/Keep.app ./dist/Keep.app

      #     # Force ad-hoc re-signing from widget to main app
      #     codesign --force --deep --sign - ./dist/Keep.app/Contents/PlugIns/NoteWidgetsExtension.appex
      #     codesign --force --deep --sign - ./dist/Keep.app

      # - name: Zip App
      #   run: |
      #     cd dist
      #     zip -r ../Keep_MacOS_${{ steps.vars.outputs.MARKETING_VERSION }}.zip Keep.app

      # - name: Create Release
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: ${{ steps.vars.outputs.MARKETING_VERSION }}
      #     name: Release ${{ steps.vars.outputs.MARKETING_VERSION }}
      #     files: Keep_MacOS_${{ steps.vars.outputs.MARKETING_VERSION }}.zip
      #     body: |
      #       ## ðŸš€ New Build (${{ steps.vars.outputs.MARKETING_VERSION }})

      #       ### âš ï¸ How to Run (Required)
      #       This app is not notarized by Apple. After downloading, you must enter the following command in the terminal.

      #       1. Move the app to the `/Applications` folder
      #       2. Open the terminal and enter the following command:
      #         `sudo xattr -rd com.apple.quarantine /Applications/Keep.app`
      #       3. Right-click the app -> Select Open
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

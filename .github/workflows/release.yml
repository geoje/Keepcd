name: Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      CHROME_VERSION: 145.0.7632.67
      SPARKLE_VERSION: 2.9.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Cache Chrome binaries
        id: cache-chrome
        uses: actions/cache@v5
        with:
          path: Binaries
          key: ${{ runner.os }}-chrome-${{ env.CHROME_VERSION }}-sparkle-${{ env.SPARKLE_VERSION }}

      - name: Download chromedriver
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          mkdir -p Binaries
          curl -L -o chromedriver.zip \
            "https://storage.googleapis.com/chrome-for-testing-public/${{ env.CHROME_VERSION }}/mac-arm64/chromedriver-mac-arm64.zip"
          unzip -o chromedriver.zip
          mv chromedriver-mac-arm64/chromedriver Binaries/chromedriver
          rm -rf chromedriver.zip chromedriver-mac-arm64

      - name: Download Chrome
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          mkdir -p Binaries
          curl -L -o chrome.zip \
            "https://storage.googleapis.com/chrome-for-testing-public/${{ env.CHROME_VERSION }}/mac-arm64/chrome-mac-arm64.zip"
          unzip -o chrome.zip
          mv chrome-mac-arm64/Google\ Chrome\ for\ Testing.app Binaries/Google\ Chrome\ for\ Testing.app
          rm -rf chrome.zip chrome-mac-arm64

      - name: Download Sparkle
        if: steps.cache-chrome.outputs.cache-hit != 'true'
        run: |
          curl -L -o sparkle.tar.xz \
            https://github.com/sparkle-project/Sparkle/releases/download/${{ env.SPARKLE_VERSION }}/Sparkle-${{ env.SPARKLE_VERSION }}.tar.xz
          tar -xf sparkle.tar.xz bin/generate_appcast
          mv bin/generate_appcast Binaries/generate_appcast
          rm -rf sparkle.tar.xz bin

      - name: Set version variables
        id: vars
        run: |
          YEAR_MONTH=$(date +'%y.%-m')
          RUN_NUMBER=${{ github.run_number }}
          PBXPROJ_VERSION=$(grep -m1 'MARKETING_VERSION =' Keep.xcodeproj/project.pbxproj \
            | sed 's/.*MARKETING_VERSION = \([0-9]*\.[0-9]*\.[0-9]*\);/\1/')
          PBXPROJ_YEAR_MONTH=$(echo "$PBXPROJ_VERSION" | cut -d. -f1-2)
          PBXPROJ_PATCH=$(echo "$PBXPROJ_VERSION" | cut -d. -f3)
          MARKETING_VERSION=$( [ "$YEAR_MONTH" = "$PBXPROJ_YEAR_MONTH" ] && echo "$YEAR_MONTH.$((PBXPROJ_PATCH + 1))" || echo "$YEAR_MONTH.0" )
          CURRENT_PROJECT_VERSION=$(date +'%Y%m%d').${{ github.run_number }}
          echo "MARKETING_VERSION=$MARKETING_VERSION" >> $GITHUB_OUTPUT
          echo "CURRENT_PROJECT_VERSION=$CURRENT_PROJECT_VERSION" >> $GITHUB_OUTPUT

      - name: Update project versions
        run: |
          sed -i '' \
            "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = ${{ steps.vars.outputs.MARKETING_VERSION }}/" \
            Keep.xcodeproj/project.pbxproj
          sed -i '' \
            "s/CURRENT_PROJECT_VERSION = [^;]*/CURRENT_PROJECT_VERSION = ${{ steps.vars.outputs.CURRENT_PROJECT_VERSION }}/" \
            Keep.xcodeproj/project.pbxproj
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Keep.xcodeproj/project.pbxproj
          git commit -m "update version to ${{ steps.vars.outputs.MARKETING_VERSION }} (${{ steps.vars.outputs.CURRENT_PROJECT_VERSION }})" || echo "no changes to commit"

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build Archive
        run: |
          xcodebuild archive \
            -project Keep.xcodeproj \
            -scheme Keep \
            -configuration Release \
            -archivePath .build/Keep.xcarchive \
            -destination "generic/platform=macOS"

      - name: Export App
        run: |
          zip -ry $GITHUB_WORKSPACE/Keep.zip \
            .build/Keep.xcarchive/Products/Applications/Keep.app

      - name: Generate Sparkle Appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo ${{ secrets.SPARKLE_PRIVATE_KEY }} | \
            ./Binaries/generate_appcast $GITHUB_WORKSPACE --ed-key-file -

      - name: Push version update
        run: |
          git push origin main

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.MARKETING_VERSION }}
          name: Keep ${{ steps.vars.outputs.MARKETING_VERSION }}
          files: |
            Keep.zip
            appcast.xml
          body: |
            ## What's New
            - None

            ## Bug Fixes
            - None
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
